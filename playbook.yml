---

- hosts: all
  become: true
  tasks:

  - name: Clone the go-dappley repository
    ansible.builtin.git:
      repo: https://github.com/dappley/go-dappley.git
      dest: /home/ubuntu/go-dappley/

  - name: Update apt
    apt:
      update_cache: yes

  - name: Upgrade apt
    apt:
      upgrade: dist

  - name: Install g++
    apt:
      name: g++

  - name: Install make
    apt:
      name: make

  - name: Download go.zip
    get_url:
      url: https://golang.org/dl/go1.16.3.linux-amd64.tar.gz
      dest: /home/ubuntu/

  - name: Extract go.tgz
    ansible.builtin.unarchive:
      src: /home/ubuntu/go1.16.3.linux-amd64.tar.gz
      dest: /usr/local/
      remote_src: yes

  - name: Add lines to .bashrc
    lineinfile:
      path: /home/ubuntu/.bashrc
      state: present
      line: "{{ item }}"
    with_items:
    - ' '
    - '# Add go to path'
    - 'export GOPATH=$HOME/go'
    - 'export GOROOT=/usr/local/go'
    - 'export PATH=$PATH:$GOROOT/bin:$GOPATH/bin'

  - name: Grant permission
    file:
      path: /home/ubuntu/go-dappley
      owner: ubuntu
      group: ubuntu
      recurse: yes

  - name: Whoami
    command: whoami
    register: whoami

  - debug:
      msg: "{{ whoami }}"

  - name:
    become: true
    become_user: ubuntu
    shell: pwd && whoami && go version
    args:
      chdir: /home/ubuntu/go-dappley
    register: directory

  - debug:
      msg: "{{ directory }}"

  - name:
    become: true
    become_user: ubuntu
    shell: make build
    args:
      chdir: /home/ubuntu/go-dappley
  

  # - name: Make build
    # shell: make build
    # args:
    #   chdir: /home/ubuntu/go-dappley

    # become: yes
    # become_method: su
    # become_user: ubuntu
    # shell: make build
    # args:
    #   chdir: /home/ubuntu/go-dappley

#     become: yes
#     become_method: su
#     become_user: ubuntu
#     make:
#       chdir: /home/ubuntu/go-dappley
#       target: build
#       file: /home/ubuntu/go-dappley/Makefile


    # make:
    #   chdir: /home/ubuntu/go-dappley 
    #   target: build
    #   file: /home/ubuntu/go-dappley/Makefile


  #   make:
  #     chdir: /home/ubuntu/go-dappley